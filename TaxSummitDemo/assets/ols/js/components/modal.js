/*! Feta
 *  @description  Framework for External Applications, RT Cluster
 *  @version      0.3.0.REL20170202
 *  @copyright    2017 New York State Office of Information Technology Services
 */

/*! Feta
 *  @description  Framework for External Applications, RT Cluster
 *  @version      0.3.0.REL20170202
 *  @copyright    2017 New York State Office of Information Technology Services
 */
define(["jquery","cui","guid","uiBox","uiPosition","css!modal"],function($,cui,guid){var NAMESPACE="modal",VERSION="3.0.2",CLASSES={hidden:"cui-hidden",modal:"cui-"+NAMESPACE,modalContents:"cui-"+NAMESPACE+"-content",modalVisibility:"cui-"+NAMESPACE+"-inivisible",overlay:"cui-"+NAMESPACE+"-overlay",closeButton:"cui-"+NAMESPACE+"-hide",modalUseHeader:"cui-"+NAMESPACE+"-use-header",modalHeader:"cui-"+NAMESPACE+"-header",modalHeaderContent:"cui-"+NAMESPACE+"-header-content",modalBody:"cui-"+NAMESPACE+"-body",modalBodyContent:"cui-"+NAMESPACE+"-body-content",modalUseFooter:"cui-"+NAMESPACE+"-use-footer",modalFooter:"cui-"+NAMESPACE+"-footer",modalFooterContent:"cui-"+NAMESPACE+"-footer-content",modalUseClose:"cui-"+NAMESPACE+"-use-close"},SELECTORS={focusableElements:"a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, [tabindex], [contenteditable]"},EVENT_NAMES={show:"show.cui."+NAMESPACE,shown:"shown.cui."+NAMESPACE,hide:"hide.cui."+NAMESPACE,hidden:"hidden.cui."+NAMESPACE,destroy:"destroy.cui"+NAMESPACE},DEFAULTS={marginX:10,marginY:10},$window=null,_priv={};_priv.buildModal=function(modal){fastdom.measure(function(){var addOverlay=!1,addModal=!1;modal.$overlay&&(document.body.contains(modal.$overlay[0])||(addOverlay=!0)),document.body.contains(modal.$self[0])||(addModal=!0),(addModal||addOverlay)&&fastdom.mutate(function(){addOverlay&&document.body.appendChild(modal.$overlay[0]),addModal&&(document.body.appendChild(modal.$self[0]),$.data(modal.$self[0],NAMESPACE,modal)),fastdom.measure(function(){"function"==typeof modal.config.onCreate&&modal.config.onCreate(modal),modal.config.autoOpen&&_priv.showModal(modal)})})})},_priv.showModal=function(modal){"function"==typeof modal.config.beforeShowFunc&&modal.config.beforeShowFunc(modal),modal.$overlay&&modal.$overlay.removeClass(CLASSES.hidden),fastdom.mutate(function(){modal.config.alwaysCenter?fastdom.mutate(function(){modal.config.buildInvisible?modal.$self.removeClass(CLASSES.modalVisibility):modal.$self.removeClass(CLASSES.hidden),_priv.adjustModalCSS(modal),_priv.adjustContentHeight(modal),_priv.centerModal(modal),"string"==typeof modal.config.focusOnShow?modal.$self.find(modal.config.focusOnShow).focus():modal.config.focusOnShow?modal.config.focusOnShow.focus():modal.$self.focus(),modal.$self.trigger(EVENT_NAMES.shown),$window.trigger(EVENT_NAMES.shown)}):fastdom.mutate(function(){modal.config.buildInvisible?modal.$self.removeClass(CLASSES.modalVisibility):modal.$self.removeClass(CLASSES.hidden),modal.$self.css("margin",DEFAULTS.marginY+"px "+DEFAULTS.marginX+"px"),_priv.adjustModalCSS(modal),_priv.adjustContentHeight(modal),"string"==typeof modal.config.focusOnShow?modal.$self.find(modal.config.focusOnShow).focus():modal.config.focusOnShow?modal.config.focusOnShow.focus():modal.$self.focus()})}),modal.config.isOpen=!0,_priv.disablePageScrolling(),modal.$self.trigger(EVENT_NAMES.show),$window.trigger(EVENT_NAMES.show),modal.config.hideOnEscape&&$window.on("keyup.cui.modal.escape",{modal:modal},_events.hideOnEscape),$window.on("resize",{modal:modal},_events.resize)},_priv.hideModal=function(modal){modal.$self.trigger(EVENT_NAMES.hide),$window.trigger(EVENT_NAMES.hide),modal.config.hideDestroy?_priv.destroyModal(modal,!0):("function"==typeof modal.config.onHide&&modal.config.onHide(modal),fastdom.mutate(function(){modal.$overlay&&modal.$overlay.addClass(CLASSES.hidden),modal.$self.addClass(CLASSES.hidden),$window.off("keyup.cui.modal.escape"),$window.off("resize",_events.resize),modal.$self.trigger(EVENT_NAMES.hidden),$window.trigger(EVENT_NAMES.hidden)})),modal.config.isOpen=!1,_priv.enablePageScrolling()},_priv.destroyModal=function(modal,doNotTriggerEvents){"function"==typeof modal.config.onHide&&modal.config.onHide(modal),fastdom.mutate(function(){doNotTriggerEvents||modal.$self.trigger(EVENT_NAMES.hide).trigger(EVENT_NAMES.hidden).trigger(EVENT_NAMES.destroy),modal.$self.remove(),modal.$focusableElems=null,modal.$overlay&&modal.$overlay.remove(),doNotTriggerEvents||$window.trigger(EVENT_NAMES.hide).trigger(EVENT_NAMES.hidden).trigger(EVENT_NAMES.destroy),"function"==typeof modal.config.onDestroy&&modal.config.onDestroy(modal),$window.off("resize",_events.resize),_priv.enablePageScrolling()})},_priv.setFocusOnClose=function(modal){modal.config.focusOnHide?(focusElem=modal.config.focusOnHide,focusElem instanceof $&&(focusElem=focusElem.get(0)),setTimeout(function(){focusElem.focus()},100)):modal.$button&&modal.$button.focus()},_priv.handleTabKey=function(modal,evt){var $focusedItem,numberOfFocusableElems,focusedItemIndex,isModalFocused=!1,isCloseButtonFocused=!1;9===evt.which&&(modal.$focusableElems||(modal.$focusableElems=modal.$self.find(SELECTORS.focusableElements).filter(":visible")),$focusedItem=$(":focus"),$focusedItem.hasClass(CLASSES.modal)||$focusedItem.hasClass(CLASSES.modalBodyContent)?isModalFocused=!0:$focusedItem.hasClass(CLASSES.closeButton)&&(isCloseButtonFocused=!0),numberOfFocusableElems=modal.$focusableElems.length,focusedItemIndex=modal.$focusableElems.index($focusedItem),evt.shiftKey?(isModalFocused||isCloseButtonFocused||0===focusedItemIndex)&&(modal.$focusableElems.get(numberOfFocusableElems-1).focus(),evt.preventDefault()):isModalFocused?(modal.$focusableElems.eq(0).hasClass(CLASSES.closeButton)&&numberOfFocusableElems>1&&focusedItemIndex<numberOfFocusableElems-1?modal.$focusableElems.get(focusedItemIndex+1).focus():modal.$focusableElems.get(0).focus(),evt.preventDefault()):isCloseButtonFocused&&numberOfFocusableElems>1?(modal.$focusableElems.get(1).focus(),evt.preventDefault()):focusedItemIndex===numberOfFocusableElems-1&&(modal.$focusableElems.get(0).focus(),evt.preventDefault()))},_priv.adjustModalCSS=function(modal){var adjustedWindowWidth=$window.width()-2*DEFAULTS.marginX,adjustedWindowHeight=$window.height()-2*DEFAULTS.marginY;modal.config.display&&modal.config.display.css&&modal.config.display.css.maxWidth?(modal.$self.css("max-width",modal.config.display.css.maxWidth),modal.$self.outerWidth()>adjustedWindowWidth&&modal.$self.css("max-width",adjustedWindowWidth+"px")):modal.$self.css("max-width",adjustedWindowWidth+"px"),modal.config.display&&modal.config.display.css&&modal.config.display.css.maxHeight?(modal.$self.css("max-height",modal.config.display.css.maxHeight),modal.$self.outerWidth()>adjustedWindowHeight&&modal.$self.css("max-height",adjustedWindowHeight+"px")):modal.$self.css("max-height",adjustedWindowHeight+"px");var headerHeight=modal.$self.find("."+CLASSES.modalHeader).outerHeight();headerHeight&&modal.$self.css("padding-top",headerHeight);var footerHeight=modal.$self.find("."+CLASSES.modalFooter).outerHeight();footerHeight&&modal.$self.css("padding-bottom",footerHeight),headerHeight+footerHeight+2>=modal.$self.outerHeight()&&journal.log({type:"warning",owner:"UI",module:"modal"},"Combined height of header and footer take up the set modal size.")},_priv.adjustContentHeight=function(modal){modal.$self.find("."+CLASSES.modalBody).css("height","auto").outerHeight(Math.floor(modal.$self.height()+1))},_priv.centerModal=function(modal){$("#"+modal.$self[0].id).uiPosition({positionType:"center-center",overrideMaxDimensions:!1})},_priv.maxContentAreaHeight=function(modal){var adjustedWindowHeight=$window.height()-2*DEFAULTS.marginY,modalSpacing=modal.$self.outerHeight()-modal.$self.height(),modalContents=modal.$self.find("."+CLASSES.modalBodyContent),modalContainerSpacing=modalContents.outerHeight()-modalContents.height();return adjustedWindowHeight-modalSpacing-modalContainerSpacing},_priv.disablePageScrolling=function(){$window.on("wheel.cui.modal",_events.stopScrollEvent),$window.on("touchmove.cui.modal",_events.stopScrollEvent),$(document).on("keydown.cui.modal",_events.stopScrollEventForKeys)},_priv.enablePageScrolling=function(){$window.off("wheel.cui.modal"),$window.off("touchmove.cui.modal"),$(document).off("keydown.cui.modal")};var _events={};_events.resize=function(evt){var modal=evt.data.modal;_priv.adjustModalCSS(modal),_priv.adjustContentHeight(modal),modal.options.alwaysCenter!==!1&&_priv.centerModal(modal),modal.config.eventHandlers.resize&&modal.config.eventHandlers.resize(evt,modal)},_events.hideOnEscape=function(evt){var modal;27===evt.keyCode&&(modal=evt.data.modal,_priv.hideModal(modal),_priv.setFocusOnClose(modal))},_events.stopScrollEvent=function(evt,$modalOuter,modalBody){$modalOuter=$modalOuter||$(evt.target).closest("."+CLASSES.modal),$modalOuter.length?(modalBody=modalBody||$modalOuter.find("."+CLASSES.modalBody).get(0),modalBody&&(evt.originalEvent.deltaY<0&&0===modalBody.scrollTop?evt.preventDefault():evt.originalEvent.deltaY>0&&modalBody.scrollHeight-modalBody.scrollTop===modalBody.clientHeight&&evt.preventDefault())):evt.preventDefault()},_events.scrollKeyCodes={37:1,38:2,39:1,40:1,32:1,33:2,34:1,35:1,36:2},_events.stopScrollEventForKeys=function(evt){var modalBody,$target=$(evt.target),$modalOuter=$target.closest("."+CLASSES.modal);if($modalOuter.length){if(modalBody=$modalOuter.find("."+CLASSES.modalBody).get(0)){if(2===_events.scrollKeyCodes[evt.keyCode]&&0===modalBody.scrollTop)return _events.stopScrollEvent(evt,$modalOuter,modalBody),!1;if(1===_events.scrollKeyCodes[evt.keyCode]&&modalBody.scrollHeight-modalBody.scrollTop===modalBody.clientHeight){if(32!==evt.keyCode||!$target.is("button, input, a"))return _events.stopScrollEvent(evt,$modalOuter,modalBody),!1}else 9!==evt.keyCode&&modalBody.focus()}}else if(_events.scrollKeyCodes[evt.keyCode])return _events.stopScrollEvent(evt,$modalOuter),!1};var Modal=function(elem,options){elem instanceof Node?(this.elem=elem,this.$button=$(elem),this.metadata=this.$button.data("modal-options")):(this.metadata={},this.$self=!1,options=elem),this.options=options};Modal.prototype={},Modal.prototype.default={html:"",display:null,overlay:!0,autoOpen:!1,hideOnEscape:!0,buildInvisible:!1,alwaysCenter:!0,focusOnShow:!1,eventHandlers:{resize:!1},modalClass:!1,focusOnHide:null,onCreate:null,header:null,footer:null,css:null},Modal.prototype.init=function(){var modal=this;$window||($window=$(window)),"string"==typeof this.options?(modal.config=$.extend(!0,{},this.default),modal.config.html=this.options):modal.config=$.extend(!0,{},this.default,this.options),modal.config.isOpen=!1,modal.config.id=guid();var modalClasses=modal.config.buildInvisible?CLASSES.modal+" "+CLASSES.modalVisibility:CLASSES.modal+" "+CLASSES.hidden;if(modal.config.modalClass&&"string"==typeof modal.config.modalClass&&(modalClasses+=" "+modal.config.modalClass),modal.config.buildInvisible&&(modal.config.builtInvisible=!0),(!modal.config.display||modal.config.display&&modal.config.display.closeButton!==!1)&&(modal.$close=$("<button/>",{class:CLASSES.closeButton,tabindex:"1"}).text("Close Modal").on("click",function(evt){evt.preventDefault(),_priv.hideModal(modal),_priv.setFocusOnClose(modal)})),!modal.$self){var boxOptions=[];if(boxOptions.id=modal.config.id,boxOptions.className=modalClasses,boxOptions.css=modal.config.css,modal.config.html){boxOptions.body=[];var bodyContent=$("<div/>",{class:CLASSES.modalBodyContent,tabindex:"1"});bodyContent.append(modal.config.html),boxOptions.body.html=bodyContent,boxOptions.body.className=CLASSES.modalBody}if(modal.config.header||modal.$close){boxOptions.header=[];var headerContent=$("<div/>",{class:CLASSES.modalHeaderContent});modal.config.header&&modal.config.header.html&&(headerContent.append(modal.config.header.html),boxOptions.className+=" "+CLASSES.modalUseHeader),modal.config.header&&modal.config.header.className&&headerContent.addClass(modal.config.header.className),modal.$close&&(headerContent.append(modal.$close),boxOptions.className+=" "+CLASSES.modalUseClose),modal.config.header&&modal.config.header.height&&(boxOptions.header.css={"min-height":modal.config.header.height}),boxOptions.header.html=headerContent,boxOptions.header.className=CLASSES.modalHeader}if(modal.config.footer&&modal.config.footer.html){boxOptions.footer=[];var footerContent=$("<div/>",{class:CLASSES.modalFooterContent});modal.config.footer.className&&footerContent.addClass(modal.config.footer.className),footerContent.append(modal.config.footer.html),modal.config.footer.height&&(boxOptions.footer.css={minHeight:modal.config.footer.height}),boxOptions.footer.html=footerContent,boxOptions.footer.className=CLASSES.modalFooter,boxOptions.className+=" "+CLASSES.modalUseFooter}modal.$self=$.uiBox(boxOptions),modal.$self.on("keydown",function(evt){_priv.handleTabKey(modal,evt)}),modal.config.overlay?(modal.config.overlay.closeOnClick!==!1?modal.$overlay=$("<div/>",{id:"overlay-"+modal.config.id,class:CLASSES.overlay+" "+CLASSES.hidden,"data-modal":modal.config.id}).on("click",function(evt){evt.preventDefault(),_priv.hideModal(modal),_priv.setFocusOnClose(modal)}):modal.$overlay=$("<div/>",{id:"overlay-"+modal.config.id,class:CLASSES.overlay+" "+CLASSES.hidden,"data-modal":modal.config.id}).on("click",function(evt){evt.preventDefault()}),modal.config.overlay.className&&modal.$overlay.addClass(modal.config.overlay.className)):modal.$overlay=!1,modal.$focusableElems=null}if(modal.config.display){if(modal.config.display.className&&modal.$self.addClass(modal.config.display.className),modal.config.display.width||modal.config.display.height){var css={};modal.config.display.width&&(css.width=modal.config.display.width),modal.config.display.height&&(css.height=modal.config.display.height),modal.$self.css(css)}modal.config.display.css&&modal.$self.css(modal.config.display.css)}return modal.config.overlay&&"object"==typeof modal.config.overlay&&!isNaN(modal.config.overlay.opacity)&&modal.$overlay.css({opacity:modal.config.overlay.opacity}),_priv.buildModal(modal),modal.$button&&modal.$button.on("click.modal."+modal.config.id,function(evt){_priv.showModal(modal)}.bind(modal)),modal},Modal.prototype.hide=function(){_priv.hideModal(this),_priv.setFocusOnClose(this)},Modal.prototype.show=function(){_priv.showModal(this)},Modal.prototype.destroy=function(){_priv.destroyModal(this)},Modal.prototype.adjustCSS=function(){_priv.adjustModalCSS(this)},Modal.prototype.adjustHeight=function(){_priv.adjustContentHeight(this)},Modal.prototype.center=function(){_priv.centerModal(this)},Modal.prototype.getMaxContentAreaHeight=function(){return _priv.maxContentAreaHeight(this)},Modal.version=VERSION,$.fn.modal=function(options,elem){return this.each(function(){$.data(this,NAMESPACE)||$.data(this,NAMESPACE,new Modal(this,options).init())})},$.modal=function(options){return new Modal(options).init()}});